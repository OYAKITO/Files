<link rel="stylesheet" href="{% static 'css/style.css' %}">

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Learning Questionnaire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #667eea);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .question-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 3px solid #e2e8f0;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-number {
            position: absolute;
            top: -15px;
            left: 20px;
            background: #4299e1;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .question-text {
            font-size: 1.4em;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.6;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1em;
            color: #4a5568;
            position: relative;
            overflow: hidden;
        }

        .option:hover {
            border-color: #4299e1;
            background: #ebf8ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.3);
        }

        .option.correct {
            border-color: #48bb78;
            background: #f0fff4;
            animation: correctPulse 0.6s ease;
        }

        .option.incorrect {
            border-color: #f56565;
            background: #fff5f5;
            animation: shake 0.6s ease;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4299e1, #667eea);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .explanation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .explanation-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
            animation: modalSlideIn 0.5s ease;
        }

        .explanation-header {
            font-size: 1.8em;
            color: #f56565;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .explanation-text {
            font-size: 1.3em;
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .correct-answer {
            background: #f0fff4;
            border: 2px solid #48bb78;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 1.2em;
            color: #2f855a;
            font-weight: bold;
        }

        .animated-character {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            animation: bounce 1s infinite;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4299e1;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9em;
        }

        .difficulty-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .difficulty-easy { background: #48bb78; }
        .difficulty-medium { background: #ed8936; }
        .difficulty-hard { background: #f56565; }

        .tts-button {
            position: absolute;
            top: 10px;
            right: 60px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .tts-button:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .loading {
            display: none;
            text-align: center;
            color: #4299e1;
            font-size: 1.2em;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        /* Animations */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌟 Smart Learning Adventure 🌟</h1>
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-number" id="correctCount">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="streakCount">0</div>
                    <div class="stat-label">Streak</div>
                </div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="question-container" id="questionContainer">
            <div class="difficulty-indicator difficulty-easy" id="difficultyIndicator">Easy</div>
            <button class="tts-button" id="ttsButton" onclick="speakQuestion()">🔊</button>
            <div class="question-number" id="questionNumber">Question 1</div>
            
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div>AI is preparing your next question...</div>
            </div>
            
            <div class="question-text" id="questionText">
                Welcome! Click "Start Learning" to begin your adventure!
            </div>
            
            <div class="options-container" id="optionsContainer">
                <!-- Options will be populated by JavaScript -->
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="startBtn" onclick="startQuestionnaire()">
                🚀 Start Learning
            </button>
            <button class="btn btn-secondary" id="nextBtn" onclick="nextQuestion()" style="display: none;">
                Next Question ➡️
            </button>
            <button class="btn btn-secondary" id="retryBtn" onclick="retryQuestion()" style="display: none;">
                🔄 Try Again
            </button>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div class="explanation-modal" id="explanationModal">
        <div class="explanation-content">
            <div class="animated-character" id="animatedCharacter">🤖</div>
            <div class="explanation-header">
                <span>Let me explain!</span>
            </div>
            <div class="explanation-text" id="explanationText">
                <!-- AI explanation will be inserted here -->
            </div>
            <div class="correct-answer" id="correctAnswerText">
                <!-- Correct answer will be shown here -->
            </div>
            <button class="btn btn-primary" onclick="closeExplanation()">
                Got it! 👍
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestion = 0;
        let correctAnswers = 0;
        let totalQuestions = 0;
        let currentStreak = 0;
        let difficulty = 'easy';
        let questions = [];
        let isAnswered = false;
        let selectedAnswer = null;

        // Sample questions structure - replace with your Django data
        const sampleQuestions = [
            {
                id: 1,
                question: "What is 2 + 2?",
                options: ["3", "4", "5", "6"],
                correctIndex: 1,
                difficulty: "easy",
                explanation: "When you add 2 + 2, you are counting: 1, 2, then 1 more, 2 more. That gives us 4!",
                correctAnswer: "4"
            },
            {
                id: 2,
                question: "Which animal says 'meow'?",
                options: ["Dog", "Cat", "Bird", "Fish"],
                correctIndex: 1,
                difficulty: "easy",
                explanation: "Cats make a 'meow' sound to communicate with humans. Dogs bark, birds chirp, and fish don't make sounds!",
                correctAnswer: "Cat"
            }
        ];

        // Initialize the questionnaire
        function initializeQuestionnaire() {
            // In Django, you would populate this with template data
            // For now, using sample data
            questions = sampleQuestions;
            updateStats();
        }

        // Start the questionnaire
        function startQuestionnaire() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';
            
            // Simulate AI processing time
            setTimeout(() => {
                loadQuestion();
                document.getElementById('loadingIndicator').style.display = 'none';
            }, 1500);
        }

        // Load current question
        function loadQuestion() {
            if (currentQuestion >= questions.length) {
                showCompletionMessage();
                return;
            }

            const question = questions[currentQuestion];
            isAnswered = false;
            selectedAnswer = null;

            // Update question display
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('questionText').textContent = question.question;
            
            // Update difficulty indicator
            const difficultyIndicator = document.getElementById('difficultyIndicator');
            difficultyIndicator.textContent = question.difficulty.charAt(0).toUpperCase() + question.difficulty.slice(1);
            difficultyIndicator.className = `difficulty-indicator difficulty-${question.difficulty}`;

            // Create options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionElement);
            });

            // Update progress bar
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;

            // Auto-speak question if TTS is available
            if ('speechSynthesis' in window) {
                setTimeout(() => speakQuestion(), 500);
            }
        }

        // Handle answer selection
        function selectAnswer(answerIndex) {
            if (isAnswered) return;

            isAnswered = true;
            selectedAnswer = answerIndex;
            const question = questions[currentQuestion];
            const options = document.querySelectorAll('.option');
            
            totalQuestions++;
            
            if (answerIndex === question.correctIndex) {
                // Correct answer
                options[answerIndex].classList.add('correct');
                correctAnswers++;
                currentStreak++;
                
                speakText("Correct! Well done!");
                document.getElementById('nextBtn').style.display = 'inline-block';
                
                // Adapt difficulty based on streak
                adaptDifficulty(true);
            } else {
                // Wrong answer
                options[answerIndex].classList.add('incorrect');
                options[question.correctIndex].classList.add('correct');
                currentStreak = 0;
                
                speakText("Oops! Let me explain.");
                showExplanation(question);
                
                // Adapt difficulty based on wrong answer
                adaptDifficulty(false);
            }
            
            updateStats();
        }

        // Show explanation modal
        function showExplanation(question) {
            document.getElementById('explanationText').textContent = question.explanation;
            document.getElementById('correctAnswerText').textContent = `The correct answer is: ${question.correctAnswer}`;
            document.getElementById('explanationModal').style.display = 'flex';
            
            // Animate character
            const character = document.getElementById('animatedCharacter');
            character.style.animation = 'bounce 1s infinite';
            
            // Speak explanation
            speakText(question.explanation);
        }

        // Close explanation modal
        function closeExplanation() {
            document.getElementById('explanationModal').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('retryBtn').style.display = 'inline-block';
        }

        // Move to next question
        function nextQuestion() {
            currentQuestion++;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('retryBtn').style.display = 'none';
            
            if (currentQuestion < questions.length) {
                document.getElementById('loadingIndicator').style.display = 'block';
                
                // Simulate AI processing for next question
                setTimeout(() => {
                    // Here you would make an AJAX call to your Django backend
                    // to get the next question based on current performance
                    loadQuestion();
                    document.getElementById('loadingIndicator').style.display = 'none';
                }, 1000);
            } else {
                showCompletionMessage();
            }
        }

        // Retry current question
        function retryQuestion() {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('retryBtn').style.display = 'none';
            loadQuestion();
        }

        // Adapt difficulty based on performance
        function adaptDifficulty(isCorrect) {
            if (isCorrect && currentStreak >= 3) {
                if (difficulty === 'easy') difficulty = 'medium';
                else if (difficulty === 'medium') difficulty = 'hard';
            } else if (!isCorrect) {
                if (difficulty === 'hard') difficulty = 'medium';
                else if (difficulty === 'medium') difficulty = 'easy';
            }
            
            // Here you would send the difficulty change to your Django backend
            // via AJAX to get appropriately difficult questions
        }

        // Text-to-speech functionality
        async function speakText(text) {
    try {
        const response = await fetch('/api/tts/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        });

        if (!response.ok) {
            console.error('TTS Error:', await response.text());
            return;
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.play();
    } catch (error) {
        console.error('TTS Request Failed:', error);
    }
}

        // Update statistics display
        function updateStats() {
            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('totalCount').textContent = totalQuestions;
            document.getElementById('streakCount').textContent = currentStreak;
        }

        // Show completion message
        function showCompletionMessage() {
            const percentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
            
            document.getElementById('questionText').innerHTML = `
                <h2>🎉 Congratulations! 🎉</h2>
                <p>You've completed the questionnaire!</p>
                <p>Your score: ${correctAnswers}/${totalQuestions} (${percentage}%)</p>
                <p>Great job learning!</p>
            `;
            
            document.getElementById('optionsContainer').innerHTML = '';
            speakText(`Congratulations! You scored ${correctAnswers} out of ${totalQuestions}. Great job learning!`);
        }

        // Initialize when page loads
        window.onload = function() {
            initializeQuestionnaire();
        };

        // Django Integration Functions
        // Add these functions to integrate with your Django backend

        function getNextQuestionFromDjango() {
            // AJAX call to Django view
            fetch('/get-next-question/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'current_difficulty': difficulty,
                    'correct_answers': correctAnswers,
                    'total_questions': totalQuestions,
                    'current_streak': currentStreak
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.question) {
                    questions.push(data.question);
                    loadQuestion();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function sendAnswerToDjango(questionId, selectedAnswer, isCorrect) {
            fetch('/submit-answer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    'question_id': questionId,
                    'selected_answer': selectedAnswer,
                    'is_correct': isCorrect,
                    'difficulty': difficulty
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Answer submitted:', data);
            })
            .catch(error => console.error('Error:', error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>